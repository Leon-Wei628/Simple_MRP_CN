# 物料需求计划(MRP)系统用户指南

## 目录

1. [系统简介](#系统简介)
2. [安装与启动](#安装与启动)
3. [数据准备](#数据准备)
4. [使用流程](#使用流程)
5. [功能说明](#功能说明)
6. [数据格式要求](#数据格式要求)
7. [常见问题](#常见问题)
8. [高级功能](#高级功能)

## 系统简介

物料需求计划(MRP)系统是一个基于Streamlit和OR-Tools的应用程序，用于计算和优化物料需求。系统通过处理生产计划、BOM、库存和采购订单数据，计算各物料的净需求量及需求时间，支持多层级BOM结构。

### 主要功能

- 上传并处理生产计划、BOM、库存和采购订单数据
- 支持多层级BOM结构的物料需求计算
- 使用OR-Tools进行优化计算
- 考虑当前库存、安全库存和在途采购订单
- 提供可视化的物料需求结果
- 支持结果导出为CSV文件

## 安装与启动

### 系统要求

- Python 3.7或更高版本
- 必要的Python包：streamlit, pandas, numpy, ortools

### 安装步骤

1. 确保已安装Python 3.7或更高版本
2. 安装必要的依赖包：

   ```bash
   pip install -r requirements.txt
   ```

### 启动系统

有两种方式启动系统：

1. **使用批处理文件启动**（推荐，仅Windows系统）：
   - 双击`run_app.bat`文件

2. **使用命令行启动**：
   - 打开命令行终端
   - 进入MRP_tools目录
   - 运行以下命令：
     ```bash
     streamlit run app.py
     ```

启动后，系统将自动在默认浏览器中打开，访问地址为：http://localhost:8501

## 数据准备

使用系统前，需要准备以下CSV格式的数据文件：

1. **生产计划**：包含最终产品的需求信息
2. **BOM数据**：包含物料清单结构信息
3. **库存数据**：包含各物料的当前库存和安全库存信息
4. **采购订单数据**（可选）：包含已下达但尚未到货的采购订单信息

系统提供了示例数据，位于`sample_data`目录中，可以用于测试和参考。

## 使用流程

1. **启动系统**：运行应用程序，在浏览器中打开系统界面

2. **上传数据**：在侧边栏依次上传以下数据文件：
   - 生产计划CSV文件
   - BOM数据CSV文件
   - 库存数据CSV文件
   - 采购订单CSV文件（可选）

3. **计算MRP**：点击侧边栏中的"计算物料需求"按钮

4. **查看结果**：在主界面的"MRP结果"标签页查看计算结果和可视化图表

5. **导出结果**：点击"下载MRP结果CSV文件"链接，将结果保存为CSV文件

## 功能说明

### 数据预览

系统提供了数据预览功能，可以在上传数据后查看数据内容：

- **生产计划**：查看产品需求信息
- **BOM数据**：查看物料清单结构
- **库存数据**：查看当前库存和安全库存
- **采购订单**：查看在途采购订单

### MRP计算

MRP计算过程包括以下步骤：

1. **数据验证**：检查上传的数据是否符合要求
2. **BOM展开**：构建多层级物料清单树结构
3. **总需求计算**：基于生产计划和BOM结构计算各物料的总需求
4. **净需求计算**：考虑当前库存、安全库存和采购订单，计算净需求
5. **结果生成**：生成包含物料编码、需求周期、总需求量、净需求量等信息的结果

### 结果展示

MRP计算结果包括以下信息：

- **物料编码**：物料的唯一标识符
- **需求周期**：需要物料的时间
- **总需求量**：该周期内的总需求量
- **期初库存**：周期开始时的库存量
- **安全库存**：最低安全库存量
- **采购到货**：该周期内预计到货的采购量
- **净需求量**：需要额外生产或采购的数量
- **期末库存**：周期结束时的预计库存量

系统还提供了物料需求时间分布的可视化图表，帮助直观了解需求分布情况。

## 数据格式要求

### 1. 生产计划 (production_plan.csv)

必须包含以下列：
- **产品编码**：最终产品的唯一标识符
- **需求数量**：需要生产的数量
- **需求日期**：需要完成生产的日期（格式：YYYY-MM-DD）

示例：
```
产品编码,产品名称,需求数量,需求日期
P001,最终产品A,100,2023-06-01
P001,最终产品A,150,2023-06-15
```

### 2. BOM数据 (bom_data.csv)

必须包含以下列：
- **父项编码**：父物料的唯一标识符
- **子项编码**：子物料的唯一标识符
- **用量**：每单位父物料需要的子物料数量

示例：
```
父项编码,父项名称,子项编码,子项名称,用量,单位
P001,最终产品A,C001,组件1,2,个
C001,组件1,M001,原材料1,3,kg
```

### 3. 库存数据 (inventory_data.csv)

必须包含以下列：
- **物料编码**：物料的唯一标识符
- **库存数量**：当前库存量
- **安全库存**：最低安全库存量

示例：
```
物料编码,物料名称,库存数量,安全库存,单位
P001,最终产品A,20,10,个
C001,组件1,50,20,个
```

### 4. 采购订单数据 (purchase_orders.csv) - 可选

如果提供，必须包含以下列：
- **物料编码**：物料的唯一标识符
- **订单数量**：采购的数量
- **预计到货日期**：预计物料到达的日期（格式：YYYY-MM-DD）

示例：
```
订单编号,物料编码,物料名称,订单数量,单位,订单日期,预计到货日期,供应商
PO001,M001,原材料1,50,kg,2023-05-15,2023-05-30,供应商A
```

## 常见问题

### 1. 上传数据时出错

**问题**：上传数据文件时显示错误信息。

**解决方案**：
- 确保CSV文件格式正确，包含所有必要的列
- 检查数据类型是否正确（如需求数量为数值型，日期为日期型）
- 确保CSV文件使用UTF-8编码

### 2. BOM循环引用错误

**问题**：计算MRP时提示"检测到BOM循环引用"。

**解决方案**：
- 检查BOM数据中是否存在循环引用（如A物料的子项是B，B的子项又是A）
- 修正BOM数据，确保物料层级结构正确

### 3. 计算结果不符合预期

**问题**：MRP计算结果与预期不符。

**解决方案**：
- 检查输入数据是否正确
- 确认安全库存设置是否合理
- 验证BOM结构是否准确
- 检查采购订单数据是否最新

## 高级功能

系统还提供了一些高级功能，可以通过修改代码来启用：

### 1. 考虑生产提前期和采购提前期

可以通过提供物料的生产提前期和采购提前期数据，使系统在计算时考虑提前期因素。

### 2. 批量约束

可以设置最小批量和批量倍数约束，使系统在计算净需求时考虑批量生产或采购的要求。

### 3. 产能约束

可以提供资源产能约束数据，使系统在计算时考虑生产资源的可用产能限制。

### 4. 物料分类

系统可以自动对物料进行分类（原材料、中间件、成品），便于分析和管理。

要使用这些高级功能，请参考`advanced_mrp.py`文件中的相关函数。

---

如有任何问题或建议，请联系系统管理员。

祝您使用愉快！